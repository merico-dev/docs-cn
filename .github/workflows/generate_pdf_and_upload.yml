name: Generate PDF and upload to official website server

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 3 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è¿è¡Œ
    - cron: "0 19 * * *"

  # æ·»åŠ  workflow_dispatch ä»¥å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  generate-pdf-and-upload:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          ref: master

      # Step 2: ä¸‹è½½å¿…è¦çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œå­—ä½“æ–‡ä»¶
      - name: Download binaries and fonts
        run: |
          mkdir -p ./bin
          mkdir -p ./fonts
          wget -P ./bin ${{ secrets.MERICO_DOCS_ASSETS_ALIYUN_OSS_PATH }}bin/pandoc.deb
          wget -P ./fonts ${{ secrets.MERICO_DOCS_ASSETS_ALIYUN_OSS_PATH }}fonts/wenquanyi-micro-hei-mono-regular.ttf
          wget -P ./fonts ${{ secrets.MERICO_DOCS_ASSETS_ALIYUN_OSS_PATH }}fonts/wenquanyi-micro-hei-regular.ttf

      # Step 3: å®‰è£… pandoc
      - name: Install pandoc
        run: |
          sudo dpkg -r pandoc
          sudo dpkg -i ./bin/pandoc.deb
          pandoc --version

      # Step 4: å®‰è£… TinyTeX
      - name: Install dependencies
        run: |
          sudo apt-get update
          chmod +x ./scripts/install_tinytex_bin_unix.sh
          ./scripts/install_tinytex_bin_unix.sh
        env:
          TINYTEX_INSTALLER: "TinyTeX-2"

      # Step 5: å°† TinyTeX æ·»åŠ åˆ° PATH
      - name: Add TinyTeX to PATH
        run: |
          sudo ~/.TinyTeX/bin/x86_64-linux/tlmgr path add
          export PATH="${HOME}/.TinyTeX/bin/x86_64-linux:$PATH"
          tlmgr --version
          echo "${HOME}/.TinyTeX/bin/x86_64-linux" >> $GITHUB_PATH

      # Step 6: å®‰è£…å­—ä½“
      - name: Install fonts
        run: |
          sudo mkdir -p /usr/share/fonts/truetype/custom
          sudo cp ./fonts/*.ttf /usr/share/fonts/truetype/custom/
          sudo fc-cache -f -v

      # Step 7: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: ">=3.10"

      # Step 8: æ ¹æ® toc å°†æ‰€æœ‰æ–‡æ¡£åˆå¹¶ä¸ºä¸€æ•´ç¯‡ markdown æ–‡æ¡£
      - name: Merge by toc
        run: |
          python scripts/merge_by_toc.py

      # Step 9: å°†åˆšæ‰åˆå¹¶å¥½çš„æ–‡æ¡£è½¬æ¢ä¸º pdf æ–‡æ¡£
      - name: Generate pdf
        run: |
          chmod +x ./scripts/generate_pdf.sh
          ./scripts/generate_pdf.sh

      # Step 10: è®¾ç½® SSH ç¯å¢ƒï¼Œä¸ºæ¥ä¸‹æ¥çš„ scp åšå‡†å¤‡
      - name: Set up SSH environment
        run: |
          mkdir -p ~/.ssh
          echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
          echo "${{ secrets.OFFICIAL_WEBSITE_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # Step 11: å°†ç”Ÿæˆçš„ pdf æ–‡ä»¶ä¼ è¾“åˆ°å®˜ç½‘æœåŠ¡å™¨
      - name: Copy files to official website server using SCP
        run: |
          scp -o ServerAliveInterval=60 merico_ee_guideline.pdf ${{ secrets.OFFICIAL_WEBSITE_PDF_TARGET }}

      # Step 12: æ¸…ç† SSH key
      - name: Clean up SSH key
        run: rm -f ~/.ssh/id_rsa

  notify-feishu-on-failure:
    runs-on: ubuntu-latest
    needs: generate-pdf-and-upload
    if: failure()
    steps:
      - name: Send notification to Feishu on failure
        run: |
          curl -X POST ${{ secrets.FEISHU_CI_BOT_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
                  "msg_type": "text",
                  "content": {
                    "text": "ğŸš¨ GitHub Action å¤±è´¥é€šçŸ¥ï¼šç”Ÿæˆ PDF æ–‡æ¡£å¹¶ä¸Šä¼ æ—¶å¤±è´¥!\n- ä»“åº“: ${{ github.repository }}\n- åˆ†æ”¯: ${{ github.ref }}\n- å·¥ä½œæµ: ${{ github.workflow }}\n- è§¦å‘äºº: ${{ github.actor }}\n- è¯¦æƒ…: ${{ github.event.head_commit.message }}\n- æŸ¥çœ‹æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }'
