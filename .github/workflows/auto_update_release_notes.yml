name: Update release notes from feishu

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 1 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è¿è¡Œ
    - cron: "0 17 * * *"

  # æ·»åŠ  workflow_dispatch ä»¥å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          ref: master

      # Step 2: ä¸‹è½½å¿…è¦çš„å¯æ‰§è¡Œæ–‡ä»¶ feishu2mdã€jqã€ossutil
      # feishu2md æ˜¯ç”¨äºè·å–é£ä¹¦æ–‡æ¡£å¹¶è½¬æ¢ä¸º markdown æ–‡æ¡£çš„å·¥å…·
      # jq æ˜¯ç”¨äºå¤„ç† json æ•°æ®çš„å·¥å…·
      # ossutil æ˜¯ç”¨äºä¸Šä¼ å›¾ç‰‡åˆ°é˜¿é‡Œäº‘ oss æœåŠ¡å™¨çš„å·¥å…·
      - name: Download binaries
        run: |
          mkdir -p ./bin
          wget -P ./bin ${{ secrets.MERICO_DOCS_ASSETS_ALIYUN_OSS_PATH }}bin/feishu2md
          wget -P ./bin ${{ secrets.MERICO_DOCS_ASSETS_ALIYUN_OSS_PATH }}bin/jq
          wget -P ./bin ${{ secrets.MERICO_DOCS_ASSETS_ALIYUN_OSS_PATH }}bin/ossutil

      # Step 3: ç»™ feishu2mdã€jqã€ossutil å¯æ‰§è¡Œæƒé™
      - name: Make feishu2md and jq and ossutil executable
        run: |
          chmod +x ./bin/feishu2md
          chmod +x ./bin/jq
          chmod +x ./bin/ossutil

      # Step 4: é…ç½® feishu2md
      - name: Configure feishu2md
        run: |
          # æŸ¥çœ‹ feishu2md ç‰ˆæœ¬
          ./bin/feishu2md --version

          # ç”Ÿæˆ feishu2md é…ç½®æ–‡ä»¶
          ./bin/feishu2md config --appId ${{ secrets.FEISHU_APP_ID }} --appSecret ${{ secrets.FEISHU_APP_SECRET }}

          # è®¾ç½® feishu2md é…ç½®æ–‡ä»¶ä¸­çš„ title_as_filename ä¸º true
          FEISHU2MD_CONF_FILE="$HOME/.config/feishu2md/config.json"
          ./bin/jq '.output.title_as_filename = true' "$FEISHU2MD_CONF_FILE" > tmp.$$.json && mv tmp.$$.json "$FEISHU2MD_CONF_FILE"

          # æŸ¥çœ‹æœ€æ–°çš„é…ç½®æ–‡ä»¶å†…å®¹
          cat "$FEISHU2MD_CONF_FILE"

      # Step 5: è¿è¡Œ feishu2md è·å–é£ä¹¦æ–‡æ¡£ï¼ˆå«æ–‡æ¡£ä¸­çš„å›¾ç‰‡ï¼‰å¹¶è½¬æ¢ä¸º markdown æ–‡æ¡£
      - name: Run feishu2md to fetch feishu docs
        run: |
          mkdir -p ./feishu2md_output
          cd feishu2md_output

          ../bin/feishu2md download --batch ${{ secrets.FEISHU_RELEASE_NOTES_FOLDER_URL }}
          ls -al

          # å»é™¤ markdown æ–‡æ¡£æ–‡ä»¶åä¸­å¼€å¤´å’Œç»“å°¾çš„ç©ºç™½å­—ç¬¦
          echo "Trimming markdown file names"
          for file in *.md; do
            if [[ -f "$file" ]]; then
              new_name=$(echo "$file" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+\.md$/.md/')
              if [[ "$file" != "$new_name" ]]; then
                # é‡å‘½åï¼Œå¦‚æœæœ‰é‡åæ–‡ä»¶ï¼Œé‚£å°±ç›´æ¥è¦†ç›–äº†
                echo "â†’ Renaming '$file' to '$new_name'"
                mv "$file" "$new_name"
              fi
            fi
          done
          ls -al

          cd ..

      # Step 6: ä½¿ç”¨ä»“åº“å†…çš„ ossutil å°†åˆšæ‰è·å–çš„å›¾ç‰‡ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ oss æœåŠ¡å™¨
      - name: Upload images in docs to Aliyun OSS
        run: |
          if [ -d "./feishu2md_output/static/" ]; then
            ./bin/ossutil config -e ${{ secrets.ALIYUN_OSS_ENDPOINT }} \
                                 -i ${{ secrets.ALIYUN_OSS_ACCESS_KEY_ID }} \
                                 -k ${{ secrets.ALIYUN_OSS_ACCESS_KEY_SECRET }}
            ./bin/ossutil cp -r ./feishu2md_output/static/ oss://${{ secrets.ALIYUN_OSS_BUCKET_COME_WITH_STATIC_PATH }} --exclude ".*" -u
          else
            echo "Directory ./feishu2md_output/static/ does not exist. Skipping upload."
          fi

      # Step 7: å¤„ç† markdown æ–‡ä»¶
      - name: Process downloaded markdown docs
        run: |
          NEW_STATIC_PATH="${{ secrets.ALIYUN_OSS_STATIC_PUBLIC_PATH }}"
          for file in ./feishu2md_output/*.md; do
            if [ -f "$file" ]; then
              # å»é™¤æ–‡æ¡£å†…å®¹çš„å‰ä¸¤è¡Œï¼ˆfeishu é‚£è¾¹çš„å‘ç‰ˆæ–‡æ¡£å·²ç»çº¦å®šå¥½äº†æ ¼å¼ï¼‰
              sed -i '1,2d' "$file"

              # åˆ é™¤â€œ## å†…éƒ¨ä¿¡æ¯â€è¡ŒåŠå…¶åçš„æ‰€æœ‰å†…å®¹ï¼ˆfeishu é‚£è¾¹çš„å‘ç‰ˆæ–‡æ¡£å·²ç»çº¦å®šå¥½äº†æ ¼å¼ï¼‰
              sed -i '/^## å†…éƒ¨ä¿¡æ¯$/,$d' "$file"

              # æ›¿æ¢å›¾ç‰‡åœ°å€ä¸ºæ–°çš„é˜¿é‡Œäº‘ oss å›¾ç‰‡åœ°å€
              sed -i -E "s|\!\[(.*?)\]\(static/(.*?)\)|\!\[\1\]($NEW_STATIC_PATH\2)|g" "$file"

              echo "Updated $file."
            else
              echo "$file is not a regular file."
            fi
          done

      # Step 8: ä½¿ç”¨ feishu2md_output ä¸­çš„ markdown æ–‡ä»¶æ›¿æ¢ release_notes ç›®å½•ä¸­çš„æ–‡ä»¶
      - name: Replace release_notes with feishu markdown files
        run: |
          # æ£€æŸ¥ release_notes ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ¸…ç©ºç›®å½•ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºç›®å½•
          if [ -d "./release_notes/" ]; then
            rm -rf ./release_notes/*
          else
            mkdir -p ./release_notes
          fi

          # æ£€æŸ¥ feishu2md_output ç›®å½•ä¸­æ˜¯å¦æœ‰ markdown æ–‡ä»¶ï¼Œæœ‰åˆ™å…¨éƒ¨å¤åˆ¶åˆ° release_notes ç›®å½•
          if ls ./feishu2md_output/*.md > /dev/null 2>&1; then
            cp ./feishu2md_output/*.md ./release_notes/
          else
            echo "There are no markdown files in feishu2md_output directory."
          fi

          ls -al ./release_notes

      # Step 9: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: ">=3.10"

      # Step 10: å®‰è£… semver ä¾èµ–ï¼Œç”¨äºæ¥ä¸‹æ¥å¯¹ release notes æŒ‰ç‰ˆæœ¬å·è¿›è¡Œæ’åº
      - name: Install semver using pip
        run: |
          pip install semver

      # Step 11: æ ¹æ® release_notes ç›®å½•ä¸­çš„ markdown æ–‡ä»¶åˆ—è¡¨æ›´æ–° toc
      - name: Update toc with release notes
        run: |
          python scripts/update_toc_with_release_notes.py

      # Step 12: ç”Ÿæˆåˆ†æ”¯åï¼Œç”¨äºå‘èµ· pull request
      - name: Generate branch name
        run: |
          BRANCH_NAME=update-release-notes-with-toc-$(date +%Y%m%d%H%M%S)
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

      # Step 13: å°± release_notes å’Œ toc çš„æ”¹åŠ¨å‘èµ· pull request
      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.REPO_SCOPED_TOKEN }}
          commit-message: "Update release notes with markdown docs from feishu"
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          branch: ${{ env.BRANCH_NAME }}
          base: master
          title: "Auto update release notes from feishu"
          body: "This PR contains updated release notes from feishu."
          delete-branch: true
          add-paths: |
            release_notes/*.md
            TOC.md
          labels: |
            release_notes_with_toc
            auto_merge

  notify-feishu-on-failure:
    runs-on: ubuntu-latest
    needs: update-release-notes
    if: failure()
    steps:
      - name: Send notification to Feishu on failure
        run: |
          curl -X POST ${{ secrets.FEISHU_CI_BOT_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
                  "msg_type": "text",
                  "content": {
                    "text": "ğŸš¨ GitHub Action å¤±è´¥é€šçŸ¥ï¼šä»é£ä¹¦æ›´æ–° Release Notes å¹¶å‘èµ· PR æ—¶å¤±è´¥ï¼\n- ä»“åº“: ${{ github.repository }}\n- åˆ†æ”¯: ${{ github.ref }}\n- å·¥ä½œæµ: ${{ github.workflow }}\n- è§¦å‘äºº: ${{ github.actor }}\n- æŸ¥çœ‹æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }'
